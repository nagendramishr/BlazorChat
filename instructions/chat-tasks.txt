# BlazorChat Implementation Tasks

## Current State Analysis
✓ .NET 10 Blazor web server with Kestrel configured
✓ ASP.NET Core Identity with Individual authentication
✓ Entity Framework Core with SQLite database
✓ Basic authentication components (Account pages)
✓ Dependency injection configured
✓ Basic Blazor components structure (Layout, Pages)

## PHASE 1: Data Layer Migration (Cosmos DB)

### Task C1.1: Install Cosmos DB Dependencies ✓
- [x] Add NuGet package: Microsoft.Azure.Cosmos (latest)
- [x] Add NuGet package: Azure.Identity (for DefaultAzureCredential)
- [ ] Remove/phase out: Microsoft.EntityFrameworkCore.Sqlite
- [x] Update src.csproj file

### Task C1.2: Create Cosmos DB Models and Schema ✓
- [x] Create folder: src/Models
- [x] Create model: src/Models/Conversation.cs
  - Properties: Id, UserId, Title, CreatedAt, UpdatedAt, PartitionKey (UserId)
- [x] Create model: src/Models/Message.cs
  - Properties: Id, ConversationId, UserId, Content, Role (User/Assistant), Timestamp, Metadata
- [x] Create model: src/Models/UserPreferences.cs
  - Properties: UserId, Theme, NotificationSettings, etc.

### Task C1.3: Create Cosmos DB Service Layer ✓
- [x] Create interface: src/Services/ICosmosDbService.cs
- [x] Create service: src/Services/CosmosDbService.cs
  - Implement singleton pattern with CosmosClient
  - Use DefaultAzureCredential for authentication
  - Implement methods: GetConversationsAsync, GetMessagesAsync, SaveMessageAsync, etc.
  - Enable diagnostic logging
- [x] Create folder: src/Services
- [x] Register service as singleton in Program.cs

### Task C1.4: Update Configuration (Partial) ⚡
- [x] Add Cosmos DB settings to appsettings.json:
  - CosmosDb:Endpoint
  - CosmosDb:DatabaseName
  - CosmosDb:ConversationsContainerName
  - CosmosDb:PreferencesContainerName
- [x] Add environment-specific configs in appsettings.Development.json
- [ ] Remove SQLite connection string

### Task C1.5: Create Cosmos DB Repository Pattern
- [x] ALTERNATIVE: Integrated CosmosDbService directly into Chat UI (simpler approach)
- [x] Implemented conversation loading from Cosmos DB
- [x] Implemented message loading with proper partition keys
- [x] Implemented conversation creation and persistence
- [x] Implemented message persistence (user and assistant)
- [x] Added error handling and user notifications
- [x] Added conversation auto-titling from first message
NOTE: Skipped separate repository layer - using service directly is sufficient for this app

## PHASE 2: Security Updates
NOTE: Current ASP.NET Core Identity with SQLite is sufficient for demo. Azure AD migration is planned for post-demo (see Phase 10).

### Task C2.1: Implement Authorization Policies (Current Identity) ✓
- [x] Create policy: UserCanAccessOwnConversations
- [x] Create authorization handler: src/Authorization/ConversationAuthorizationHandler.cs
- [x] Register policies in Program.cs
- [x] Apply [Authorize] attributes to endpoints/components

### Task C2.2: Configure CORS ✓
- [x] Add CORS policy in Program.cs (AllowConfiguredOrigins policy)
- [x] Configure allowed origins in appsettings.json (Cors:AllowedOrigins array)
- [x] Apply CORS middleware (UseCors)

### Task C2.3: Implement Rate Limiting ✓
- [x] Add NuGet package: Microsoft.AspNetCore.RateLimiting (built-in to ASP.NET Core)
- [x] Configure rate limiting policies in Program.cs (GlobalLimit: 100/min, AILimit: 20/min)
- [x] Apply rate limiting middleware (UseRateLimiter)
- [x] Configure limits in appsettings.json (RateLimiting section)

### Task C2.4: Add Azure Key Vault Integration ✓
- [x] Add NuGet package: Azure.Extensions.AspNetCore.Configuration.Secrets
- [x] Add NuGet package: Azure.Security.KeyVault.Secrets
- [x] Update Program.cs to add Key Vault configuration provider
- [x] Configure Key Vault URL in appsettings.json
- [x] Move sensitive settings (AI Foundry keys) to Key Vault (optional configuration)

### Task C2.5: Input Validation & Sanitization ✓
- [x] Add NuGet package: System.ComponentModel.Annotations (built-in)
- [x] Create validation models: src/Models/ValidationModels.cs
  - ChatMessageInput, ConversationInput, OrganizationInput
- [x] Implement message sanitization service: src/Services/MessageSanitizationService.cs
  - SanitizeMessage, SanitizeSlug, SanitizeCss, ContainsPromptInjection
- [x] Add validation attributes to input models
- [x] Register sanitization service in Program.cs (singleton)

## PHASE 2.5: Multi-Organization Architecture (New)
Goal: Support multiple organizations with isolated configuration and branding sharing the same db instance.

### Task C2.5.1: Multi-Organization Database Schema ✓
- [x] Create model: src/Models/Organization.cs
  - Properties: Id, Name, Slug (Index), PublicThemeSettings, PrivateAIConfig
  - Look & Feel: CustomCss (string), HeaderHtml (string), FooterHtml (string)
  - NOTE: Split model into "OrganizationPublicDTO" (Theme/Branding) for UI and "OrganizationSecrets" for Server to prevent leaking AI keys via public URL probing.
- [x] Update model: src/Data/ApplicationUser.cs
  - Add property: OrganizationId

### Task C2.5.2: Organization Resolution Strategy ✓
- [x] Implement Organization Service: src/Services/OrganizationService.cs
- [x] Update routing to support `/org/{slug}/...`
- [x] Create Organization Resolver Component: src/Components/Shared/OrganizationResolver.razor
- [x] Validate Slug Uniqueness on creation.

### Task C2.5.3: Organization Management API Service (New) ✓
- [x] Create interface: src/Services/IOrganizationAdminService.cs
- [x] Implement service: src/Services/OrganizationAdminService.cs
  - Methods: CreateOrganizationAsync, UpdateOrganizationAsync, DisableOrganizationAsync, ListOrganizationsAsync
- [x] Create API Endpoints or Admin Page to manage organizations.
  - Implemented `src/Controllers/OrganizationController.cs`
- [ ] Create Admin Policy: Require "GlobalAdmin" role.
- [ ] Create Admin UI Pages (optional for now, API first).

### Task C2.5.4: Infrastructure Automation ✓
- [x] Create Azure CLI setup script: scripts/init-azure-resources.ps1 (and .sh)
- [x] Verify script creates all containers including `organizations`.
- [x] Update CosmosDbService to manage Organizations container logic.

### Task C2.5.5: UI Configuration Updates ✓
- [x] Update MainLayout to support dynamic branding colors (MudBlazor).
- [x] Add Organization Awareness to NavMenu.
- [x] Fix MudBlazor provider duplication issues in interactive rendering.
- [ ] Create page: src/Components/Pages/Admin/OrganizationList.razor
- [ ] Implement basic CRUD for Organizations

## PHASE 3: Application Insights & Monitoring

### Task C3.1: Add Application Insights ✓
- [x] Add NuGet package: Microsoft.ApplicationInsights.AspNetCore
- [x] Add Application Insights to Program.cs
- [x] Configure instrumentation key in appsettings.json
- [x] Enable connection string in appsettings (use Key Vault)

### Task C3.2: Add Custom Telemetry ✓
- [x] Create service: src/Services/TelemetryService.cs
- [x] Add custom events: MessageSent, MessageReceived, AIResponseTime
- [x] Add custom metrics: ConversationLength, TokenUsage, ResponseLatency
- [x] Track exceptions with custom properties
- [x] Register service in Program.cs

### Task C3.3: Add Health Checks ✓
- [x] Add NuGet package: Microsoft.Extensions.Diagnostics.HealthChecks (built-in to ASP.NET Core)
- [x] Create health check: src/HealthChecks/CosmosDbHealthCheck.cs
- [x] Create health check: src/HealthChecks/AIFoundryHealthCheck.cs
- [x] Add health check endpoints in Program.cs:
  - /liveness (basic app alive check)
  - /startup (dependencies initialized check)
  - /readiness (ready to accept traffic check)
- [ ] Configure health check UI (optional)

### Task C3.4: Cosmos DB Diagnostic Logging ✓
- [x] Enable Cosmos DB diagnostics in CosmosDbService
- [x] Log diagnostic strings for slow queries (> threshold)
- [x] Log diagnostic strings on errors
- [ ] Add custom log filtering in appsettings.json

## PHASE 4: AI Foundry Integration

### Task C4.1: Add AI Foundry SDK ✓
- [x] Add NuGet package: Azure.AI.Projects
- [x] Add NuGet package: Microsoft.Agents.AI.AzureAI
- [x] Add configuration in appsettings.json:
  - AIFoundry:Endpoint
  - AIFoundry:ModelDeployment
  - AIFoundry:AgentName
  - AIFoundry:AgentInstructions
- [ ] Store API keys in Key Vault (user will provide endpoint details)

### Task C4.2: Create AI Service Layer ✓
- [x] Create interface: src/Services/IAIFoundryService.cs
- [x] Create service: src/Services/AIFoundryService.cs
  - Implement agent communication with Microsoft Agent Framework
  - Implement streaming response support
  - Implement error handling and thread management
  - Implement conversation context via AgentThread
  - Use DefaultAzureCredential
- [x] Register service in Program.cs
- [x] Integrate with Chat.razor for streaming responses

### Task C4.5: Multi-Organization AI Configuration (New) ✓
- [x] Create AIFoundryServiceFactory: src/Services/AIFoundryServiceFactory.cs
  - Factory pattern for creating org-specific AI service instances
  - OrganizationAIConfiguration wrapper for dynamic config
- [x] Implement dynamic agent configuration resolution based on current Organization
- [x] AIFoundryService accepts IConfiguration (works with org-specific config)
- [x] Register AIFoundryServiceFactory in Program.cs
- [ ] Test with multiple agent endpoints

### Task C4.3: Create Conversation Context Manager ✓
- [x] Create service: src/Services/ConversationContextManager.cs
- [x] Implement token counting
- [x] Implement context trimming strategy
- [x] Implement conversation summarization stub
- [x] Register service in Program.cs
- [x] Integrate into Chat.razor for token limit checking

### Task C4.3.5: Thread Persistence & Rehydration on Conversation Resume (New) ⚠️
Goal: Restore AI agent context when user resumes a previous conversation without double-billing tokens.

**Problem Identified**:
- Agent threads are ephemeral (in-memory `_conversationThreads` dictionary)
- When user resumes conversation, `GetOrAdd()` creates a NEW thread
- AI agent loses all previous context → poor UX ("Who are you?")
- Thread also lost on: app restart, server scaling, thread expiration (~24hrs)
- Message replay consumes tokens AGAIN → double-billing users

**Solution Strategy**: Thread Persistence (Primary) + Message Replay (Fallback)

```
Resume conversation
       ↓
Check Conversation.AgentThreadId exists?
       ↓
   ┌───┴───┐
   Yes     No
   ↓       ↓
Try resume    Create new thread
Azure thread  + Replay messages
   ↓             ↓
Thread valid?    Track as "rehydrationTokens"
   ↓             (separate from user billing)
   Yes → Use it (0 extra tokens!)
   No → Fallback to replay
```

#### C4.3.5.1: Extend Conversation Model for Thread Persistence
- [ ] Add to src/Models/Conversation.cs:
  ```
  agentThreadId: string?       # Azure AI thread ID for resume
  agentThreadCreatedAt: DateTime?  # Track thread age
  agentThreadExpiry: DateTime?     # When thread likely expires (~24hrs)
  ```
- [ ] Update CosmosDbService to save/retrieve thread ID

#### C4.3.5.2: Implement Thread Resume Logic
- [ ] Add method to IAIFoundryService: `TryResumeThreadAsync(agentThreadId) → bool`
- [ ] Update AIFoundryService to check Azure AI for existing thread validity
- [ ] On successful resume, populate `_conversationThreads` from persisted ID
- [ ] Update Conversation.AgentThreadId when new thread created

#### C4.3.5.3: Implement Message Replay Fallback
- [ ] Add method to IAIFoundryService: `RehydrateThreadAsync(conversationId, messages)`
- [ ] Update AIFoundryService to accept message history for thread initialization
- [ ] Use ConversationContextManager to trim history to fit token budget
- [ ] Track rehydration tokens separately (see Task C4.4)

#### C4.3.5.4: Integrate with Chat.razor
- [ ] Modify `SelectConversation()` to attempt thread resume first
- [ ] Fallback to message replay if thread expired/invalid
- [ ] Call rehydration BEFORE user can send messages (prevent race condition)
- [ ] Show loading state during rehydration

#### C4.3.5.5: Configuration
- [ ] Add configuration: `AIFoundry:ThreadExpiryHours` (default: 24)
- [ ] Add configuration: `AIFoundry:RehydrationMessageCount` (default: 20)
- [ ] Add configuration: `AIFoundry:RehydrationTokenBudget` (default: 8000)
- [ ] Add configuration: `AIFoundry:EnablePromptCaching` (default: true)

**Edge Cases to Handle**:
- [ ] Very long conversations (summarize older messages)
- [ ] Conversations with file attachments (skip or reference only)
- [ ] Rate limiting during bulk message replay
- [ ] User sends message before rehydration completes
- [ ] Thread expired but user hasn't interacted in days

### Task C4.4: Add Usage Tracking
Goal: Track AI usage metrics for cost management, analytics, and quota enforcement.

#### C4.4.1: Storage Strategy (Cosmos DB)
**Container**: `usage` (new container)
**Partition Key**: `/organizationId` (enables per-org billing and analytics)
**Hierarchical Partition Key (HPK)**: Consider `/organizationId/userId` for large orgs

**Document Types** (stored in same container with `type` discriminator):
1. **ConversationUsage** - Aggregated usage per conversation
2. **DailyUsageSummary** - Daily rollup per user/org for dashboards
3. **AIRequestLog** - Individual AI request details (optional, high volume)

#### C4.4.2: Create Usage Models
- [ ] Create model: src/Models/AIUsage.cs
  ```
  ConversationUsage:
  - id: string (conversationId)
  - type: "conversationUsage"
  - organizationId: string (partition key)
  - userId: string
  - conversationId: string
  
  # User-billable tokens (actual new content)
  - userInputTokens: int          # User's new messages
  - assistantOutputTokens: int    # AI's new responses
  - totalBillableTokens: int      # userInput + assistantOutput
  
  # Operational tokens (system overhead - not billed to user)
  - rehydrationInputTokens: int   # Tokens for context replay on resume
  - rehydrationCount: int         # Number of times thread was rehydrated
  
  # Cache efficiency tracking
  - promptCacheHits: int          # Requests that hit prompt cache
  - promptCacheMisses: int        # Requests without cache benefit
  - cachedTokens: int             # Tokens served from cache (50% cost)
  
  - totalRequests: int
  - estimatedUserCostUsd: decimal     # Cost for user-billable tokens
  - estimatedOperationalCostUsd: decimal  # Cost for rehydration (org absorbs)
  - modelDeployment: string
  - createdAt: DateTime
  - updatedAt: DateTime
  
  DailyUsageSummary:
  - id: string (orgId_userId_date)
  - type: "dailySummary"
  - organizationId: string (partition key)
  - userId: string
  - date: string (yyyy-MM-dd)
  
  # Billable vs operational breakdown
  - userInputTokens: int
  - assistantOutputTokens: int
  - rehydrationTokens: int
  - cachedTokens: int
  
  - totalRequests: int
  - rehydrationCount: int
  - conversationCount: int
  - resumedConversationCount: int   # Convos that needed rehydration
  
  - estimatedUserCostUsd: decimal
  - estimatedOperationalCostUsd: decimal
  ```

#### C4.4.3: Extend Existing Models
- [ ] Extend MessageMetadata (already exists) to include:
  - inputTokens: int (prompt tokens)
  - outputTokens: int (completion tokens)
  - promptCacheHit: bool (Azure AI prompt caching)
  - cachedTokens: int (tokens served from cache at 50% cost)
  - isRehydrationMessage: bool (true if sent during context replay)
  
- [ ] Extend Conversation model to include usage summary:
  - totalBillableTokens: int       # User-billable only
  - totalRehydrationTokens: int    # Operational overhead
  - totalRequests: int
  - rehydrationCount: int          # Times this convo was resumed
  - lastModelUsed: string
  - agentThreadId: string?         # For thread persistence (see C4.3.5)
  - agentThreadCreatedAt: DateTime?

#### C4.4.4: Create Usage Service
- [ ] Create interface: src/Services/IUsageTrackingService.cs
- [ ] Create service: src/Services/UsageTrackingService.cs
  - TrackUserRequestAsync(conversationId, inputTokens, outputTokens, modelName, responseTimeMs, cacheHit)
  - TrackRehydrationAsync(conversationId, rehydrationTokens, messageCount) # Separate tracking!
  - GetConversationUsageAsync(conversationId)
  - GetUserDailySummaryAsync(userId, date)
  - GetOrganizationUsageAsync(orgId, startDate, endDate)
  - GetRehydrationCostAsync(orgId, startDate, endDate) # Org operational cost report
  - UpdateDailySummaryAsync() - called after each request
- [ ] Register service as singleton in Program.cs

#### C4.4.5: Integrate with AIFoundryService
- [ ] Capture token counts from AI response (Azure.AI.Projects SDK provides usage info)
- [ ] Call UsageTrackingService.TrackAIRequestAsync after each AI response
- [ ] Handle tracking failures gracefully (don't fail chat if tracking fails)

#### C4.4.6: Application Insights Integration
- [ ] Log custom metrics to Application Insights:
  - ai.tokens.input.user (counter) - billable input tokens
  - ai.tokens.output.user (counter) - billable output tokens
  - ai.tokens.rehydration (counter) - operational overhead tokens
  - ai.tokens.cached (counter) - tokens served from cache
  - ai.request.duration (histogram)
  - ai.request.cost.user (counter) - user-billable cost
  - ai.request.cost.operational (counter) - rehydration cost
  - ai.cache.hit.rate (gauge) - prompt cache efficiency
  - ai.rehydration.count (counter) - thread rehydration events
- [ ] Create custom dimensions: organizationId, userId, modelDeployment, isRehydration
- [ ] Enable correlation with existing TelemetryService
- [ ] Create Azure Monitor workbook for cost breakdown (user vs operational)

#### C4.4.7: Cost Estimation Configuration
- [ ] Add pricing config to appsettings.json:
  ```json
  "AIUsage": {
    "PricingPerMillionTokens": {
      "gpt-4o": { "input": 2.50, "output": 10.00 },
      "gpt-4o-mini": { "input": 0.15, "output": 0.60 }
    },
    "DefaultModel": "gpt-4o-mini"
  }
  ```
- [ ] Create pricing lookup service for cost calculation

#### C4.4.8: Usage Reporting & Dashboard (Future - Phase 7)
Goal: Provide visibility into AI usage and costs for users, org admins, and global admins.

**User Views** (see their own usage):
- [ ] Create page: src/Components/Pages/Account/MyUsage.razor
  - Daily/weekly/monthly usage summary
  - Token breakdown (input vs output)
  - Cost estimates for current billing period
  - Conversation count and average tokens per conversation
  - Top 5 most expensive conversations

**Organization Admin Views** (see org-wide usage):
- [ ] Create page: src/Components/Pages/Admin/OrgUsageDashboard.razor
  - Aggregate usage across all org users
  - Per-user breakdown with sortable table
  - Billable vs operational cost split (rehydration overhead)
  - Usage trends chart (last 30 days)
  - Export to CSV functionality

**Global Admin Views** (see all organizations):
- [ ] Create page: src/Components/Pages/Admin/GlobalUsageDashboard.razor
  - Per-organization usage comparison
  - System-wide token consumption
  - Rehydration cost analysis (optimization opportunity)
  - Prompt cache hit rate metrics
  - Anomaly detection (unusual usage spikes)

**Shared Components**:
- [ ] Create component: src/Components/Shared/UsageChart.razor (MudBlazor charts)
- [ ] Create component: src/Components/Shared/TokenBreakdownCard.razor
- [ ] Create component: src/Components/Shared/CostEstimateCard.razor
- [ ] Create component: src/Components/Shared/UsageTable.razor (sortable/filterable)

**API Endpoints**:
- [ ] GET /api/usage/me - Current user's usage summary
- [ ] GET /api/usage/me/daily?start={date}&end={date} - User's daily breakdown
- [ ] GET /api/usage/org/{orgId} - Org usage summary (org admin only)
- [ ] GET /api/usage/org/{orgId}/users - Per-user breakdown (org admin only)
- [ ] GET /api/usage/global - All orgs summary (global admin only)
- [ ] GET /api/usage/export?orgId={orgId}&format=csv - Export functionality

**Authorization**:
- [ ] Users can only see their own usage
- [ ] Org admins can see aggregate org usage + per-user breakdown
- [ ] Global admins can see all organizations
- [ ] Add policies: "CanViewOrgUsage", "CanViewGlobalUsage"

**Performance Considerations**:
- [ ] Cache daily summaries (they don't change after day ends)
- [ ] Use pagination for user lists (large orgs)
- [ ] Pre-aggregate monthly rollups via background job
- [ ] Consider Azure Monitor workbooks for heavy analytics

## PHASE 5: Chat UI Components

### Task C5.1: Add Chat Component Library ✓
- [x] Research and select Blazor chat UI library (e.g., MudBlazor, FluentUI)
- [x] Add NuGet package for selected library
- [x] Configure library in Program.cs
- [x] Update _Imports.razor with library namespaces

### Task C5.2: Create Chat Components ✓
- [x] Create component: src/Components/Pages/Chat.razor
  - Display conversation list
  - Display message history
  - Input box for new messages
  - Send button
- [x] Create component: src/Components/Chat/MessageList.razor
- [x] Create component: src/Components/Chat/MessageItem.razor
- [x] Create component: src/Components/Chat/ChatInput.razor
- [x] Create component: src/Components/Chat/ConversationSidebar.razor
 ✓
- [x] Add NuGet package: Markdig (0.44.0)
- [x] Create component: src/Components/Shared/MarkdownRenderer.razor
- [x] Create styles: src/Components/Shared/MarkdownRenderer.razor.css
- [x] Integrate into Chat.razor for AI message rendering
- [x] Add GitHub-style formatting for code blocks, tables, lists, header
- [ ] Add syntax highlighting for code blocks

### Task C5.4: Organization-Based Theming (Revised) ✓
- [x] Organization model already includes Custom CSS and HTML snippets (PublicThemeSettings)
- [x] Create service: src/Services/ThemeService.cs
  - GetThemeForOrganization, GetCustomCss, GetDefaultTheme
  - Dynamic MudTheme generation from org colors
- [x] Create component: src/Components/Shared/OrganizationStyleProvider.razor
  - Renders sanitized custom CSS
  - Renders organization header HTML
- [ ] Update MainLayout.razor to use OrganizationStyleProvider
- [x] CSS sanitization via MessageSanitizationService
- [x] Fallback to default theme if no organization settings found
### Task C5.5: Implement Theme Customization
- [ ] Create theme configuration in appsettings.json
- [ ] Create CSS variables for theming in app.css
- [ ] Create service: src/Services/ThemeService.cs
- [ ] Add theme selector in UI
- [ ] Persist user preference to Cosmos DB

## PHASE 6: Real-time Features (SignalR)

### Task C6.1: Add SignalR Infrastructure
- [ ] Add NuGet package: Microsoft.AspNetCore.SignalR (already in .NET)
- [ ] Create hub: src/Hubs/ChatHub.cs
- [ ] Register SignalR in Program.cs
- [ ] Map hub endpoint

### Task C6.2: Implement Streaming Responses
- [ ] Add streaming methods to ChatHub
- [ ] Update AIFoundryService to support streaming
- [ ] Update Chat.razor to receive streaming messages
- [ ] Implement progressive message rendering

### Task C6.3: Add Typing Indicators
- [ ] Add typing indicator methods to ChatHub
- [ ] Create component: src/Components/Chat/TypingIndicator.razor
- [ ] Implement typing event emission from ChatInput
- [ ] Display typing indicators in MessageList

### Task C6.4: Connection State Management
- [ ] Implement reconnection logic in Chat.razor
- [ ] Add connection status indicator component
- [ ] Handle offline scenarios gracefully
- [ ] Show connection state to user

## PHASE 7: Additional Features

### Task C7.1: Implement Caching
- [ ] Add memory cache for conversation metadata
- [ ] Implement cache invalidation strategy
- [ ] Add cache configuration in appsettings.json
- [ ] Register cache in Program.cs

### Task C7.2: Add Search Functionality
- [ ] Create search endpoint/method in ConversationRepository
- [ ] Implement full-text search (consider Azure Cognitive Search)
- [ ] Create search UI component
- [ ] Add search results highlighting

### Task C7.3: Add Export Functionality
- [ ] Create service: src/Services/ExportService.cs
- [ ] Implement export to JSON
- [ ] Implement export to Markdown
- [ ] Add export button to conversation UI
- [ ] Generate downloadable files

### Task C7.4: User Preferences
- [ ] Create UserPreferences repository
- [ ] Create preferences UI page
- [ ] Implement save/load preferences
- [ ] Apply preferences across app (theme, notifications, etc.)

### Task C7.5: File Upload (Optional)
- [ ] Add file upload component
- [ ] Configure Azure Blob Storage
- [ ] Add NuGet package: Azure.Storage.Blobs
- [ ] Implement file upload service
- [ ] Store file references in Cosmos DB

## PHASE 8: Testing & Quality

### Task C8.1: Unit Tests
- [ ] Add test project: BlazorChat.Tests
- [ ] Add NuGet package: xUnit
- [ ] Add NuGet package: Moq
- [ ] Write tests for CosmosDbService
- [ ] Write tests for AIFoundryService
- [ ] Write tests for ConversationRepository
- [ ] Write tests for authorization handlers

### Task C8.2: Integration Tests
- [ ] Add test project: BlazorChat.IntegrationTests
- [ ] Add NuGet package: Microsoft.AspNetCore.Mvc.Testing
- [ ] Write integration tests for API endpoints
- [ ] Test authentication flows
- [ ] Test Cosmos DB integration with emulator

### Task C8.3: Add Swagger/OpenAPI
- [ ] Add NuGet package: Swashbuckle.AspNetCore
- [ ] Configure Swagger in Program.cs
- [ ] Add XML documentation to API methods
- [ ] Configure Swagger UI

## PHASE 9: DevOps & Deployment

### Task C9.1: Docker Support
- [ ] Create Dockerfile in project root
- [ ] Create .dockerignore file
- [ ] Test local Docker build
- [ ] Optimize image size (multi-stage build)

### Task C9.2: Environment Configuration
- [ ] Finalize appsettings.Production.json
- [ ] Document required environment variables
- [ ] Add configuration validation on startup
- [ ] Create configuration README

### Task C9.3: CI/CD Pipeline
- [ ] Create .github/workflows/build.yml (or Azure DevOps YAML)
- [ ] Add build and test steps
- [ ] Add Docker build and push steps
- [ ] Add deployment steps for Azure App Service or ACA
- [ ] Configure environment secrets

### Task C9.4: Azure Resources Setup
- [ ] Create Bicep/Terraform templates in /deploy
- [ ] Define Cosmos DB account and database
- [ ] Define App Service or Azure Container Apps
- [ ] Define Application Insights
- [ ] Define Key Vault
- [ ] Document deployment steps

## PHASE 10: External Identity Providers & Enterprise Authentication
NOTE: Enable social login for consumer scenarios + enterprise SSO for B2B deployments.

### Task C10.1: External Identity Provider Integration (Social Login)
Goal: Allow users to sign in with existing accounts from popular providers.

#### C10.1.1: Add External Provider NuGet Packages
- [ ] Add NuGet package: Microsoft.AspNetCore.Authentication.Google
- [ ] Add NuGet package: Microsoft.AspNetCore.Authentication.Facebook
- [ ] Add NuGet package: Microsoft.AspNetCore.Authentication.Twitter (for X)
- [ ] Add NuGet package: Microsoft.AspNetCore.Authentication.MicrosoftAccount

#### C10.1.2: Configure Provider App Registrations
- [ ] Register app with Google Cloud Console (OAuth 2.0 credentials)
  - Authorized redirect URI: `https://{domain}/signin-google`
- [ ] Register app with Facebook Developer Portal
  - Valid OAuth redirect URI: `https://{domain}/signin-facebook`
- [ ] Register app with X (Twitter) Developer Portal
  - Callback URL: `https://{domain}/signin-twitter`
- [ ] Register app with Microsoft Entra ID (Azure Portal)
  - Redirect URI: `https://{domain}/signin-microsoft`
- [ ] Store all client IDs and secrets in Azure Key Vault

#### C10.1.3: Update Program.cs Authentication Configuration
- [ ] Add authentication services for each provider:
  ```csharp
  .AddGoogle(options => { ... })
  .AddFacebook(options => { ... })
  .AddTwitter(options => { ... })
  .AddMicrosoftAccount(options => { ... })
  ```
- [ ] Configure callback paths for each provider
- [ ] Map external claims to local user properties

#### C10.1.4: Configuration in appsettings.json
- [ ] Add ExternalProviders section:
  ```json
  "ExternalProviders": {
    "Google": { "ClientId": "", "ClientSecret": "" },
    "Facebook": { "AppId": "", "AppSecret": "" },
    "Twitter": { "ConsumerKey": "", "ConsumerSecret": "" },
    "Microsoft": { "ClientId": "", "ClientSecret": "" }
  }
  ```
- [ ] Use Key Vault references for secrets in production

#### C10.1.5: Update Login UI
- [ ] Update src/Components/Account/Pages/Login.razor
  - Add "Sign in with Google" button
  - Add "Sign in with Facebook" button
  - Add "Sign in with X" button
  - Add "Sign in with Microsoft" button
- [ ] Create component: src/Components/Account/Shared/ExternalLoginButtons.razor
- [ ] Style buttons with provider brand colors/icons

#### C10.1.6: Handle External Login Callback
- [ ] Update src/Components/Account/Pages/ExternalLogin.razor
- [ ] Link external account to existing local account (if email matches)
- [ ] Create new local account if first-time external login
- [ ] Handle account linking conflicts gracefully

#### C10.1.7: User Profile Updates
- [ ] Store external provider info in ApplicationUser:
  - ExternalProvider: string (Google, Facebook, X, Microsoft)
  - ExternalProviderId: string
  - ProfilePictureUrl: string (from provider)
- [ ] Allow users to link/unlink multiple providers in Account settings
- [ ] Display provider icon next to user's name

#### C10.1.8: Organization-Level Provider Control (Optional)
- [ ] Allow org admins to enable/disable specific providers per org
- [ ] Add to Organization model:
  - AllowedExternalProviders: string[] (e.g., ["Google", "Microsoft"])
- [ ] Filter login buttons based on org settings

### Task C10.2: Enterprise SSO (Azure AD / Microsoft Entra ID)
Goal: Enable enterprise single sign-on for B2B deployments.

- [ ] Replace ASP.NET Core Identity with Azure AD (Microsoft Entra ID)
- [ ] Add NuGet package: Microsoft.Identity.Web
- [ ] Add NuGet package: Microsoft.Identity.Web.UI
- [ ] Update Program.cs to use AddMicrosoftIdentityWebApp
- [ ] Configure Azure AD settings in appsettings.json:
  - AzureAd:Instance
  - AzureAd:Domain
  - AzureAd:TenantId
  - AzureAd:ClientId
- [ ] Remove Entity Framework Identity dependencies
- [ ] Plan user data migration from SQLite to Azure AD
- [ ] Update authorization policies to work with Azure AD claims
- [ ] Test SSO and multi-factor authentication flows

### Task C10.3: Hybrid Authentication Strategy
Goal: Support both social login (consumers) and enterprise SSO (B2B) simultaneously.

- [ ] Implement authentication mode per organization:
  - "social" - Only external providers (Google, Facebook, X, Microsoft personal)
  - "enterprise" - Only Azure AD tenant (Microsoft work/school)
  - "hybrid" - Both options available
- [ ] Add to Organization model: AuthenticationMode: string
- [ ] Route users to appropriate login flow based on org settings
- [ ] Handle seamless transitions when org upgrades from social to enterprise

## PHASE 11: Compliance & Governance

### Task C11.1: Data Retention
- [ ] Define retention policies
- [ ] Create cleanup service: src/Services/DataRetentionService.cs
- [ ] Implement background job for old data deletion
- [ ] Configure TTL in Cosmos DB (optional)

### Task C11.2: GDPR Compliance
- [ ] Add export user data endpoint
- [ ] Add delete user data endpoint (right to be forgotten)
- [ ] Create privacy policy page
- [ ] Add consent management

### Task C11.3: Audit Logging
- [ ] Create audit log model
- [ ] Log sensitive operations (delete, export, admin actions)
- [ ] Store audit logs in separate Cosmos DB container
- [ ] Create audit log query endpoint (admin only)

## PRIORITY ORDER

### Immediate (MVP - Week 1-2)
1. Task C1.1 - C1.5: Cosmos DB Migration
2. Task C.4.1 - C4.2: Basic AI Foundry Integration
3. Task C.5.1 - C5.2: Basic Chat UI
4. Task C.3.1: Application Insights Setup

### High Priority (Week 3-4)
5. Task C2.4: Key Vault Integration
7. Task C5.3 - C5.4: Markdown & Loading States
8. Task C3.2 - C3.4: Monitoring & Health Checks
9. Task C4.3: Context Management

### Medium Priority (Week 5-6)
10. Task C2.3 - C2.4: CORS & Rate Limiting
11. Task C2.6: Input Validation
12. Task C6.1 - C6.2: SignalR & Streaming
13. Task C5.5: Theme Customization
14. Task C7.1: Caching

### Lower Priority (Week 7-8)
15. Task C6.3 - C6.4: Advanced SignalR Features
16. Task C7.2 - C7.4: Search, Export, Preferences
17. Task C8.1 - C8.2: Testing
18. Task C9.1 - C9.2: Docker & Configuration

### Future Enhancements
19. Task 4.4: AI Usage Tracking
20. Task 7.5: File Upload
21. Task 8.3: Swagger
22. Task 9.3-9.4: CI/CD & IaC

### Post-Demo Enterprise Features
23. Task 10.1: Azure AD Authentication Migration (Enterprise SSO)
24. Task 11.1-11.3: Compliance Features (Data Retention, GDPR, Audit Logging)


