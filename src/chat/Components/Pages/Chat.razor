@page "/chat"
@page "/chat/{ConversationId}"
@page "/org/{OrganizationSlug}/chat"
@page "/org/{OrganizationSlug}/chat/{ConversationId}"
@using Microsoft.AspNetCore.Authorization
@using BlazorChat.Shared.Models
@using src.Services
@using src.Services.Application
@inject IChatApplicationService ChatService
@inject IOrganizationService OrganizationService
@inject ISnackbar Snackbar
@inject ILogger<Chat> _logger
@attribute [Authorize]

<PageTitle>Chat - BlazorChat</PageTitle>

<MudPaper Elevation="0" Class="d-flex" Style="height: 100%;">
    
    @* Conversation Sidebar - Collapsible *@
    <MudPaper Elevation="1" Class="flex-none d-flex flex-column" Style="@GetSidebarStyle()">
        @* Sidebar Header with Toggle *@
        <MudPaper Elevation="0" Class="pa-2 d-flex align-center justify-space-between">
            @if (_sidebarOpen)
            {
                <MudText Typo="Typo.subtitle2" Class="ml-2">Conversations</MudText>
            }
            <MudTooltip Text="@(_sidebarOpen ? "Collapse sidebar" : "Expand sidebar")">
                <MudIconButton Icon="@(_sidebarOpen ? Icons.Material.Filled.ChevronLeft : Icons.Material.Filled.ChevronRight)" 
                              Size="Size.Small"
                              OnClick="ToggleSidebar" />
            </MudTooltip>
        </MudPaper>
            
            @if (_sidebarOpen)
            {
                <MudPaper Elevation="0" Class="pa-2">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Add"
                              FullWidth="true"
                              OnClick="CreateNewConversation">
                        New Chat
                    </MudButton>
                </MudPaper>
                <MudDivider />
                
                <div style="flex: 1; overflow-y: auto;">
                    @if (_conversations == null)
                    {
                        <MudPaper Elevation="0" Class="pa-2">
                            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                        </MudPaper>
                    }
                    else if (!_conversations.Any())
                    {
                        <MudPaper Elevation="0" Class="pa-2">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">No conversations yet</MudText>
                        </MudPaper>
                    }
                    else
                    {
                        @foreach (var conv in _conversations)
                        {
                            <MudPaper Elevation="@(_currentConversationId == conv.Id ? 2 : 0)" 
                                     Class="pa-2 ma-1" 
                                     Style="@(_currentConversationId == conv.Id ? "background-color: #e3f2fd;" : "")">
                                <div class="d-flex align-center justify-space-between">
                                    <div class="flex-grow-1 cursor-pointer" @onclick="@(() => SelectConversation(conv.Id))">
                                        <MudText Typo="Typo.body1">@conv.Title</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @conv.UpdatedAt.ToLocalTime().ToString("MMM d, h:mm tt")
                                        </MudText>
                                    </div>
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                 Size="Size.Small" 
                                                 Color="Color.Error"
                                                 OnClick="@(async () => await DeleteConversation(conv.Id))"
                                                 title="Delete conversation" />
                                </div>
                            </MudPaper>
                        }
                    }
                </div>
            }
            else
            {
                @* Collapsed state - show icons only *@
                <MudTooltip Text="New Chat" Placement="Placement.Right">
                    <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                  Color="Color.Primary" 
                                  OnClick="CreateNewConversation" />
                </MudTooltip>
                <MudDivider />
                <div style="flex: 1; overflow-y: auto;">
                    @if (_conversations != null)
                    {
                        @foreach (var conv in _conversations)
                        {
                            <MudTooltip Text="@conv.Title" Placement="Placement.Right">
                                <MudIconButton Icon="@Icons.Material.Filled.Chat" 
                                              Size="Size.Small"
                                              Color="@(_currentConversationId == conv.Id ? Color.Primary : Color.Default)"
                                              OnClick="@(() => SelectConversation(conv.Id))"
                                              Class="ma-1" />
                            </MudTooltip>
                        }
                    }
                </div>
            }
        </MudPaper>

        @* Main Chat Area *@
        <MudPaper Elevation="0" Class="flex-grow-1 d-flex flex-column" Style="height: 100%;">
            
            @* Chat Header *@
            <MudPaper Elevation="1" Class="pa-2 d-flex align-center">
                <MudTooltip Text="Toggle conversations">
                    <MudIconButton Icon="@(_sidebarOpen ? Icons.Material.Filled.ChevronLeft : Icons.Material.Filled.Chat)" 
                                  Color="Color.Primary" 
                                  OnClick="ToggleSidebar" />
                </MudTooltip>
                <MudText Typo="Typo.h6" Class="ml-2">@_currentConversationTitle</MudText>
                <MudSpacer />
                @if (!string.IsNullOrEmpty(_currentConversationId))
                {
                    <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Default" />
                }
            </MudPaper>

            @* Messages Area *@
            <MudPaper Class="flex-grow-1 pa-4" Style="overflow-y: auto; height: 100%;" id="messageContainer">
                @if (_isLoadingMessages)
                {
                    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                }
                else if (!_messages.Any() && !string.IsNullOrEmpty(_currentConversationId))
                {
                    <MudText Typo="Typo.body1" Align="Align.Center" Class="mt-8">
                        No messages yet. Start the conversation!
                    </MudText>
                }
                else if (string.IsNullOrEmpty(_currentConversationId))
                {
                    <div class="d-flex flex-column align-center justify-center" style="height: 100%;">
                        <MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Typo="Typo.h5" Class="mt-4">Welcome to BlazorChat</MudText>
                        <MudText Typo="Typo.body1" Color="Color.Secondary">
                            Select a conversation or start a new one
                        </MudText>
                    </div>
                }
                else
                {
                    @foreach (var message in _messages)
                    {
                        <div class="@GetMessageClass(message)" style="margin-bottom: 16px;">
                            <MudPaper Elevation="1" Class="pa-3" Style="@GetMessageStyle(message)">
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-1">
                                    @(message.Role == MessageRole.User ? "You" : "Assistant")
                                    â€¢ @message.Timestamp.ToLocalTime().ToString("h:mm tt")
                                </MudText>
                                @if (message.Role == MessageRole.Assistant)
                                {
                                    <src.Components.Shared.MarkdownRenderer Content="@message.Content" />
                                }
                                else
                                {
                                    <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@message.Content</MudText>
                                }
                            </MudPaper>
                        </div>
                    }
                    
                    @if (_isLoading)
                    {
                        <div class="d-flex align-start" style="margin-bottom: 16px;">
                            <MudPaper Elevation="1" Class="pa-3" Style="max-width: 70%; background-color: #f5f5f5;">
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            </MudPaper>
                        </div>
                    }
                }
            </MudPaper>

            @* Input Area *@
            @if (!string.IsNullOrEmpty(_currentConversationId))
            {
                <MudPaper Elevation="2" Class="pa-3">
                    <div class="d-flex gap-2">
                        <MudTextField @bind-Value="_currentMessage"
                                     @bind-Value:after="StateHasChanged"
                                     Label="Type a message..."
                                     Variant="Variant.Outlined"
                                     Lines="3"
                                     FullWidth="true"
                                     Immediate="true"
                                     Disabled="@_isLoading"
                                     OnKeyDown="HandleKeyPress" />
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  StartIcon="@Icons.Material.Filled.Send"
                                  Disabled="@(string.IsNullOrWhiteSpace(_currentMessage) || _isLoading)"
                                  OnClick="SendMessage"
                                  Style="align-self: flex-end;">
                            Send
                        </MudButton>
                    </div>
                </MudPaper>
            }
        </MudPaper>
    </MudPaper>

@code {
    [Parameter]
    public string? ConversationId { get; set; }

    [Parameter]
    public string? OrganizationSlug { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    // UI State
    private List<Conversation>? _conversations;
    private List<Message> _messages = new();
    private string? _currentConversationId;
    private string _currentConversationTitle = "Chat";
    private string _currentMessage = string.Empty;
    private bool _isLoading = false;
    private bool _isLoadingMessages = false;
    private bool _sidebarOpen = true;
    private string? _currentUserId;
    private CancellationTokenSource? _sendMessageCts;

    private string GetSidebarStyle() => _sidebarOpen 
        ? "width: 300px; height: 100%; transition: width 0.2s ease-in-out;" 
        : "width: 56px; height: 100%; transition: width 0.2s ease-in-out;";

    private void ToggleSidebar() => _sidebarOpen = !_sidebarOpen;

    protected override async Task OnInitializedAsync()
    {
        // Get current user
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        }

        // Default userId for testing if not authenticated
        if (string.IsNullOrEmpty(_currentUserId))
        {
            _currentUserId = "test-user";
        }

        // Load conversations
        await LoadConversations();

        // If a conversation ID is provided in the route, load it
        if (!string.IsNullOrEmpty(ConversationId))
        {
            await SelectConversation(ConversationId);
        }
    }

    private async Task LoadConversations()
    {
        try
        {
            _logger.LogInformation("Loading conversations for user {UserId}", _currentUserId);
            var conversationList = await ChatService.GetUserConversationsAsync(_currentUserId!);
            _conversations = conversationList.ToList();
            _logger.LogInformation("Loaded {Count} conversations", _conversations.Count);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to load conversations for user {UserId}", _currentUserId);
            Snackbar.Add($"Failed to load conversations: {ex.Message}", Severity.Error);
            _conversations = new List<Conversation>();
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task CreateNewConversation()
    {
        try
        {
            var savedConv = await ChatService.CreateConversationAsync(_currentUserId!);
            _conversations?.Insert(0, savedConv);
            await SelectConversation(savedConv.Id);
            Snackbar.Add("New conversation created", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to create conversation: {ex.Message}", Severity.Error);
        }
    }

    private async Task SelectConversation(string conversationId)
    {
        // Try to find in local cache first
        var conversation = _conversations?.FirstOrDefault(c => c.Id == conversationId);
        
        // If not found (e.g. deep link), fetch from service
        if (conversation == null)
        {
            conversation = await ChatService.GetConversationAsync(conversationId, _currentUserId!);
            if (conversation == null)
            {
                Snackbar.Add("Conversation not found or you do not have permission to view it.", Severity.Error);
                return;
            }
        }

        _currentConversationId = conversationId;
        _currentConversationTitle = conversation.Title;

        // Resume conversation (for future thread rehydration)
        await ChatService.ResumeConversationAsync(conversationId, _currentUserId!);

        // Load messages
        await LoadMessages(conversationId);
    }

    private async Task DeleteConversation(string conversationId)
    {
        try
        {
            var conversation = _conversations?.FirstOrDefault(c => c.Id == conversationId);
            if (conversation == null) return;

            var deleted = await ChatService.DeleteConversationAsync(conversationId, _currentUserId!);
            if (!deleted)
            {
                Snackbar.Add("Failed to delete conversation", Severity.Error);
                return;
            }

            // Remove from local list
            _conversations?.RemoveAll(c => c.Id == conversationId);

            // Clear view if we deleted the current conversation
            if (_currentConversationId == conversationId)
            {
                _currentConversationId = null;
                _currentConversationTitle = "Chat";
                _messages = new List<Message>();
            }

            Snackbar.Add($"Conversation '{conversation.Title}' deleted", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to delete conversation: {ex.Message}", Severity.Error);
            _logger.LogError(ex, "Error deleting conversation {ConversationId}", conversationId);
        }
    }

    private async Task LoadMessages(string conversationId)
    {
        _isLoadingMessages = true;
        StateHasChanged();

        try
        {
            var messageList = await ChatService.GetMessagesAsync(conversationId, _currentUserId!);
            _messages = messageList.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load messages: {ex.Message}", Severity.Error);
            _messages = new List<Message>();
        }
        finally
        {
            _isLoadingMessages = false;
            StateHasChanged();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_currentMessage) || string.IsNullOrEmpty(_currentConversationId))
            return;

        var sentMessage = _currentMessage;
        _currentMessage = string.Empty;
        
        // Add user message to UI immediately
        var userMessage = new Message
        {
            Id = Guid.NewGuid().ToString(),
            ConversationId = _currentConversationId,
            UserId = _currentUserId!,
            Content = sentMessage,
            Role = MessageRole.User,
            Timestamp = DateTime.UtcNow
        };
        _messages.Add(userMessage);

        // Create assistant message placeholder
        var assistantMessage = new Message
        {
            Id = Guid.NewGuid().ToString(),
            ConversationId = _currentConversationId,
            UserId = _currentUserId!,
            Content = string.Empty,
            Role = MessageRole.Assistant,
            Timestamp = DateTime.UtcNow
        };
        _messages.Add(assistantMessage);

        _isLoading = true;
        StateHasChanged();

        _sendMessageCts = new CancellationTokenSource();

        try
        {
            // Stream AI response via application service
            await foreach (var chunk in ChatService.SendMessageStreamingAsync(
                _currentConversationId, _currentUserId!, sentMessage, _sendMessageCts.Token))
            {
                if (!string.IsNullOrEmpty(chunk.Error))
                {
                    Snackbar.Add($"Error: {chunk.Error}", Severity.Error);
                    assistantMessage.Content = "Sorry, I encountered an error processing your request. Please try again.";
                    break;
                }

                assistantMessage.Content += chunk.Content;
                assistantMessage.Id = chunk.MessageId ?? assistantMessage.Id;
                StateHasChanged();

                if (chunk.IsComplete)
                {
                    break;
                }
            }

            // Update conversation in local list
            var conversation = _conversations?.FirstOrDefault(c => c.Id == _currentConversationId);
            if (conversation != null)
            {
                conversation.UpdatedAt = DateTime.UtcNow;
                conversation.MessageCount += 2; // User + assistant messages
                
                // Update title if auto-generated
                if (conversation.Title == "New Conversation")
                {
                    conversation.Title = sentMessage.Length > 50 
                        ? sentMessage.Substring(0, 47) + "..." 
                        : sentMessage;
                    _currentConversationTitle = conversation.Title;
                }
            }
        }
        catch (OperationCanceledException)
        {
            _logger.LogInformation("Message sending was cancelled");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to send message: {ex.Message}", Severity.Error);
            _logger.LogError(ex, "Error sending message in conversation {ConversationId}", _currentConversationId);
            
            // Remove failed messages
            _messages.Remove(userMessage);
            _messages.Remove(assistantMessage);
        }
        finally
        {
            _isLoading = false;
            _sendMessageCts?.Dispose();
            _sendMessageCts = null;
            StateHasChanged();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private string GetMessageClass(Message message) =>
        message.Role == MessageRole.User ? "d-flex justify-end" : "d-flex justify-start";

    private string GetMessageStyle(Message message)
    {
        var baseStyle = "max-width: 70%;";
        return message.Role == MessageRole.User
            ? baseStyle + " background-color: #1976d2; color: white;"
            : baseStyle + " background-color: #f5f5f5;";
    }
}
