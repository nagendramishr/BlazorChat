@page "/admin/organizations"
@using src.Services
@using src.Models
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "GlobalAdmin")]
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject ITenantAdminService TenantAdminService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Organization Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
    <MudText Typo="Typo.h4" GutterBottom="true">Organizations</MudText>
    <MudText Typo="Typo.subtitle1" Class="mb-4">Manage multi-tenant chat configurations.</MudText>

    <MudTable Items="@organizations" Dense="true" Hover="true" Bordered="true" Striped="true" Filter="new Func<Organization,bool>(FilterFunc1)" @bind-SelectedItem="selectedItem1">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Tenants</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="searchString1" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenCreateDialog" Class="ml-4">Create New</MudButton>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Slug</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Branding</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Slug">
                <MudLink Href="@($"/org/{context.Slug}/chat")" Target="_blank">@context.Slug</MudLink>
            </MudTd>
            <MudTd DataLabel="Status">
                @if (context.IsDisabled)
                {
                    <MudChip T="string" Color="Color.Error" Size="Size.Small">Disabled</MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small">Active</MudChip>
                }
            </MudTd>
            <MudTd DataLabel="Branding">
                <div style="width: 20px; height: 20px; background-color: @context.PublicThemeSettings?.PrimaryColor; border-radius: 50%; display: inline-block;"></div>
            </MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="@(() => OpenEditDialog(context))" Size="Size.Small" />
                @if (!context.IsDisabled)
                {
                     <MudIconButton Icon="@Icons.Material.Filled.Block" Color="Color.Warning" OnClick="@(() => ToggleStatus(context))" Size="Size.Small" Title="Disable" />
                }
                else 
                {
                     <MudIconButton Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" OnClick="@(() => ToggleStatus(context))" Size="Size.Small" Title="Enable" />
                }
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
</MudContainer>

@code {
    private IEnumerable<Organization> organizations = new List<Organization>();
    private string searchString1 = "";
    private Organization selectedItem1 = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        organizations = await TenantAdminService.ListOrganizationsAsync();
    }

    private bool FilterFunc1(Organization element) => FilterFunc(element, searchString1);

    private bool FilterFunc(Organization element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (element.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.Slug.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<OrganizationDialog>("Create Organization", options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled) 
        {
            var newOrg = (Organization?)result.Data;
            if (newOrg != null)
            {
                try 
                {
                    await TenantAdminService.OnboardOrganizationAsync(newOrg);
                    Snackbar.Add("Organization created!", Severity.Success);
                    await LoadData();
                } 
                catch (Exception ex) 
                {
                    Snackbar.Add($"Error: {ex.Message}", Severity.Error);
                }
            }
        }
    }

    private async Task OpenEditDialog(Organization org)
    {
        var parameters = new DialogParameters { ["Organization"] = org, ["IsEdit"] = true };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<OrganizationDialog>("Edit Organization", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled) 
        {
            var updatedOrg = (Organization?)result.Data;
            if (updatedOrg != null)
            {
                try 
                {
                    await TenantAdminService.UpdateOrganizationAsync(updatedOrg.Id, updatedOrg);
                    Snackbar.Add("Organization updated!", Severity.Success);
                await LoadData();
            } 
            catch (Exception ex) 
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
            }
        }
    }

    private async Task ToggleStatus(Organization org)
    {
        try 
        {
            if (org.IsDisabled)
                await TenantAdminService.EnableOrganizationAsync(org.Id);
            else
                await TenantAdminService.DisableOrganizationAsync(org.Id);
            
            await LoadData();
        } 
        catch (Exception ex) 
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}
