@inherits LayoutComponentBase
@inject src.Services.IOrganizationService OrganizationService
@inject NavigationManager Navigation
@using MudBlazor

<MudThemeProvider Theme="_currentTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Dense="true" Style="@($"background: {_currentTheme.PaletteLight.Primary}; color: {_currentTheme.PaletteLight.TextPrimary};")">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@DrawerToggle" aria-label="Toggle navigation" />
        
        @if (HasCustomHeader)
        {
             @((MarkupString)(OrganizationService.CurrentOrganization?.PublicThemeSettings?.HeaderHtml ?? ""))
        }
        else 
        {
             <MudText Typo="Typo.h6" Class="ml-3">BlazorChat</MudText>
        }
       
        <MudSpacer />
        
        <AuthorizeView>
            <Authorized>
                 <MudText Typo="Typo.body2" Class="mr-4">@context.User.Identity?.Name</MudText>
                 <MudButton Variant="Variant.Text" Color="Color.Inherit" OnClick="Logout" StartIcon="@Icons.Material.Filled.Logout">Logout</MudButton>
            </Authorized>
            <NotAuthorized>
                <MudButton Variant="Variant.Text" Color="Color.Inherit" href="Account/Login">Login</MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>

    <div @onmouseenter="OnDrawerMouseEnter" @onmouseleave="OnDrawerMouseLeave">
        <MudDrawer @bind-Open="_drawerOpen" 
                   ClipMode="DrawerClipMode.Always" 
                   Elevation="2"
                   Variant="@(_useMiniDrawer ? DrawerVariant.Mini : DrawerVariant.Responsive)">
            <NavMenu DrawerOpen="_drawerOpen" UseMiniDrawer="_useMiniDrawer" />
        </MudDrawer>
    </div>

    <MudMainContent Class="d-flex flex-column" Style="height: calc(100vh - 48px);">
        @Body
        
        @if (!string.IsNullOrEmpty(OrganizationService.CurrentOrganization?.PublicThemeSettings?.FooterHtml))
        {
             <div class="mt-4">
                 @((MarkupString)OrganizationService.CurrentOrganization.PublicThemeSettings.FooterHtml)
             </div>
        }
    </MudMainContent>
</MudLayout>

@implements IDisposable

@code {
    private bool _drawerOpen = true;
    private bool _drawerOpenedByHover = false;
    private MudTheme _currentTheme = new MudTheme();
    private System.Threading.Timer? _hoverTimer;
    private const int HoverDelayMs = 1000; // 1 second delay before expanding on hover
    
    // Feature toggle: When true, collapsed drawer shows icons only; when false, drawer fully hides
    private const bool _useMiniDrawer = true;

    [CascadingParameter(Name = "CurrentOrganization")]
    public BlazorChat.Shared.Models.Organization? CurrentOrganization { get; set; }

    protected override void OnInitialized()
    {
        UpdateTheme();
    }

    protected override void OnParametersSet()
    {
        UpdateTheme();
    }

    private void UpdateTheme()
    {
        // Prioritize Cascading Parameter, fall back to Service (which should be same)
        var org = CurrentOrganization ?? OrganizationService.CurrentOrganization;

        if (org != null)
        {
            _currentTheme = new MudTheme()
            {
                PaletteLight = new PaletteLight()
                {
                    Primary = org.PublicThemeSettings.PrimaryColor ?? "#594AE2",
                    Secondary = org.PublicThemeSettings.SecondaryColor ?? "#fa541c",
                    AppbarBackground = org.PublicThemeSettings.PrimaryColor ?? "#594AE2",
                    AppbarText = Colors.Shades.White
                }
            };
        }
        else
        {
            // Default Theme
            _currentTheme = new MudTheme();
        }
        // Note: Don't call StateHasChanged() here - the framework handles it after lifecycle methods
    }

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }
    
    // Check if we have a robust header
    bool HasCustomHeader => !string.IsNullOrEmpty(OrganizationService.CurrentOrganization?.PublicThemeSettings?.HeaderHtml);

    private void Logout()
    {
        Navigation.NavigateTo("Account/Logout", true); 
    }

    private void OnDrawerMouseEnter()
    {
        // Only start timer if using mini drawer and drawer is currently collapsed
        if (_useMiniDrawer && !_drawerOpen)
        {
            _hoverTimer?.Dispose();
            _hoverTimer = new System.Threading.Timer(async _ =>
            {
                await InvokeAsync(() =>
                {
                    _drawerOpen = true;
                    _drawerOpenedByHover = true;
                    StateHasChanged();
                });
            }, null, HoverDelayMs, System.Threading.Timeout.Infinite);
        }
    }

    private void OnDrawerMouseLeave()
    {
        // Cancel any pending hover timer
        _hoverTimer?.Dispose();
        _hoverTimer = null;

        // If drawer was opened by hover, close it when mouse leaves
        if (_drawerOpenedByHover)
        {
            _drawerOpen = false;
            _drawerOpenedByHover = false;
        }
    }

    public void Dispose()
    {
        _hoverTimer?.Dispose();
    }
}
