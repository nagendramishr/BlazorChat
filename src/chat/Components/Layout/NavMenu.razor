@using src.Services
@inject IOrganizationService OrganizationService
@inject NavigationManager Navigation
@using MudBlazor

<MudNavMenu>
    <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">@(ShowText ? "Home" : "")</MudNavLink>
    
    @if (OrganizationService.CurrentOrganization != null)
    {
         <MudNavLink Href="@($"/org/{OrganizationService.CurrentOrganization.Slug}/chat")" Icon="@Icons.Material.Filled.Chat">@(ShowText ? $"Chat ({OrganizationService.CurrentOrganization.Name})" : "")</MudNavLink>
    }
    else 
    {
        <MudNavLink Href="chat" Icon="@Icons.Material.Filled.Chat">@(ShowText ? "Chat" : "")</MudNavLink>
    }

    <MudNavLink Href="auth" Icon="@Icons.Material.Filled.Lock">@(ShowText ? "Auth Required" : "")</MudNavLink>
    
    <MudDivider Class="my-2" />

    <AuthorizeView Policy="GlobalAdmin">
         <Authorized>
             <MudNavLink Href="admin/organizations" Icon="@Icons.Material.Filled.AdminPanelSettings">@(ShowText ? "Admin Console" : "")</MudNavLink>
             <MudDivider Class="my-2" />
         </Authorized>
    </AuthorizeView>

    <AuthorizeView>
        <Authorized>
            <MudNavLink Href="Account/Manage" Icon="@Icons.Material.Filled.Person">@(ShowText ? context.User.Identity?.Name : "")</MudNavLink>
             @* 
               Since Logout requires a form post for Antiforgery in the default Identity template, 
               we keep a hidden form or use a controller. 
               For now, let's just link to the page that auto-submits or handles it if possible, 
               or use the form approach. 
             *@
             <div class="mud-nav-item">
                 <form action="Account/Logout" method="post">
                    <AntiforgeryToken />
                    <input type="hidden" name="ReturnUrl" value="" />
                    <button type="submit" class="mud-nav-link mud-ripple">
                        <MudIcon Icon="@Icons.Material.Filled.Logout" Class="mud-nav-link-icon" />
                        @if (ShowText)
                        {
                            <span class="mud-nav-link-text">Logout</span>
                        }
                    </button>
                </form>
             </div>
        </Authorized>
        <NotAuthorized>
            <MudNavLink Href="Account/Register" Icon="@Icons.Material.Filled.PersonAdd">@(ShowText ? "Register" : "")</MudNavLink>
            <MudNavLink Href="Account/Login" Icon="@Icons.Material.Filled.Login">@(ShowText ? "Login" : "")</MudNavLink>
        </NotAuthorized>
    </AuthorizeView>
</MudNavMenu>

@code {
    [Parameter]
    public bool DrawerOpen { get; set; } = true;
    
    [Parameter]
    public bool UseMiniDrawer { get; set; } = true;
    
    // Show text when drawer is open, or when not using mini drawer mode (full hide/show)
    private bool ShowText => DrawerOpen || !UseMiniDrawer;
}

<style>
    /* Quick fix to make the button look like a MudNavLink */
    button.mud-nav-link {
        width: 100%;
        background: none;
        border: none;
        text-align: left;
        padding: 10px 16px;
        display: flex;
        align-items: center;
        color: var(--mud-palette-text-primary);
        font-family: var(--mud-typography-body1-family);
        font-size: var(--mud-typography-body1-size);
        font-weight: var(--mud-typography-body1-weight);
        line-height: 1.75;
    }
    button.mud-nav-link:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
    .mud-nav-link-text {
        margin-left: 20px; /* MudBlazor default icon spacing */
    }
</style>

