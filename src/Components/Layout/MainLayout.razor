@inherits LayoutComponentBase
@inject src.Services.ITenantService TenantService
@inject NavigationManager Navigation
@using MudBlazor

<MudThemeProvider Theme="_currentTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Dense="true" Style="@($"background: {_currentTheme.PaletteLight.Primary}; color: {_currentTheme.PaletteLight.TextPrimary};")">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        
        @if (HasCustomHeader)
        {
             @((MarkupString)(TenantService.CurrentTenant?.PublicThemeSettings?.HeaderHtml ?? ""))
        }
        else 
        {
             <MudText Typo="Typo.h6" Class="ml-3">BlazorChat</MudText>
        }
       
        <MudSpacer />
        
        <AuthorizeView>
            <Authorized>
                 <MudText Typo="Typo.body2" Class="mr-4">@context.User.Identity?.Name</MudText>
                 <MudButton Variant="Variant.Text" Color="Color.Inherit" OnClick="Logout" StartIcon="@Icons.Material.Filled.Logout">Logout</MudButton>
            </Authorized>
            <NotAuthorized>
                <MudButton Variant="Variant.Text" Color="Color.Inherit" href="Account/Login">Login</MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavMenu />
    </MudDrawer>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="my-4 pt-4">
            @Body
        </MudContainer>
        
        @if (!string.IsNullOrEmpty(TenantService.CurrentTenant?.PublicThemeSettings?.FooterHtml))
        {
             <div class="mt-4">
                 @((MarkupString)TenantService.CurrentTenant.PublicThemeSettings.FooterHtml)
             </div>
        }
    </MudMainContent>
</MudLayout>

@code {
    bool _drawerOpen = true;
    private MudTheme _currentTheme = new MudTheme();

    [CascadingParameter(Name = "CurrentTenant")]
    public src.Models.Organization? CurrentTenant { get; set; }

    protected override void OnInitialized()
    {
        UpdateTheme();
    }

    protected override void OnParametersSet()
    {
        UpdateTheme();
    }

    private void UpdateTheme()
    {
        // Prioritize Cascading Parameter, fall back to Service (which should be same)
        var tenant = CurrentTenant ?? TenantService.CurrentTenant;

        if (tenant != null)
        {
            _currentTheme = new MudTheme()
            {
                PaletteLight = new PaletteLight()
                {
                    Primary = tenant.PublicThemeSettings.PrimaryColor ?? "#594AE2",
                    Secondary = tenant.PublicThemeSettings.SecondaryColor ?? "#fa541c",
                    AppbarBackground = tenant.PublicThemeSettings.PrimaryColor ?? "#594AE2",
                    AppbarText = Colors.Shades.White
                }
            };
        }
        else
        {
            // Default Theme
            _currentTheme = new MudTheme();
        }
        StateHasChanged();
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }
    
    // Check if we have a robust header
    bool HasCustomHeader => !string.IsNullOrEmpty(TenantService.CurrentTenant?.PublicThemeSettings?.HeaderHtml);

    private void Logout()
    {
        Navigation.NavigateTo("Account/Logout", true); 
        // Note: Identity logout usually requires a POST form or a redirect controller. 
        // For simplicity reusing the link, but standard Identity requires form.
        // Users should use the sidebar or we implement a controller redirect.
    }
}
